name: Anonymous Passwordless SSH Server with Bore.pub

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ssh-server:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install SSH Server and Rust
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server curl build-essential

        # Install Rust and Cargo
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env
    
    - name: Install Bore CLI using Cargo
      run: |
        source $HOME/.cargo/env
        cargo install bore-cli
        
    - name: Configure Passwordless SSH Server
      run: |
        sudo tee /etc/ssh/sshd_config > /dev/null <<EOF
Port 22
Protocol 2

# --- LOGIN POR SENHA VAZIA FUNCIONANDO ---
PasswordAuthentication yes
PermitEmptyPasswords yes
UsePAM no
PubkeyAuthentication no
ChallengeResponseAuthentication no

PermitRootLogin yes
StrictModes no
AllowUsers *

X11Forwarding yes
PrintMotd yes
Subsystem sftp /usr/lib/openssh/sftp-server
EOF
        
    - name: Create Users with Empty Passwords
      run: |
        sudo passwd -d root
        
        sudo useradd -m -s /bin/bash topuser
        sudo passwd -d topuser
        
        sudo usermod -aG sudo topuser
        echo 'topuser ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/topuser
        sudo chmod 440 /etc/sudoers.d/topuser

    - name: Start SSH Service
      run: |
        sudo ssh-keygen -A
        sudo systemctl enable ssh
        sudo systemctl restart ssh

        echo "ğŸ” SSH Status:"
        sudo systemctl status ssh --no-pager
        
        echo "ğŸ” Testing login sem senha:"
        echo "" | ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=yes topuser@localhost "echo OK" || echo "Falhou"

    - name: Start Bore Tunnel
      run: |
        source $HOME/.cargo/env
        echo "ğŸš€ Starting bore tunnel for SSH..."
        
        $HOME/.cargo/bin/bore local 22 --to bore.pub > bore_output.txt 2>&1 &
        sleep 15
        
        echo "========================================"
        echo "ğŸ¯ SSH SERVER IS READY!"
        echo "========================================"
        
        cat bore_output.txt || true
        
        PORT=$(grep -oE "bore\.pub:[0-9]+" bore_output.txt | cut -d: -f2)
        
        if [ ! -z "$PORT" ]; then
          echo ""
          echo "ğŸŒ SSH sem senha:"
          echo "   ssh root@bore.pub -p ${PORT}"
          echo "   ssh topuser@bore.pub -p ${PORT}"
          echo ""
          echo "ğŸ‘‰ Quando pedir senha: apenas aperte ENTER"
        else
          echo "âš ï¸ NÃ£o consegui pegar a porta do Bore"
        fi
        
        echo "========================================"
        echo "ğŸ”„ Mantendo o servidor ativo por 6 horas..."
        sleep 21600
