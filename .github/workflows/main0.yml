name: Secure SSH Server with Bore.pub (keys only)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ssh-server:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install prerequisites and Rust
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server curl build-essential

        # Install Rust (cargo)
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env

    - name: Install Bore CLI using Cargo
      run: |
        source $HOME/.cargo/env
        cargo install bore-cli || true

    - name: Configure SSH (keys only)
      env:
        SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        # Write secure sshd_config (NO empty passwords)
        sudo tee /etc/ssh/sshd_config > /dev/null <<'EOF'
Port 22
Protocol 2

# Use public-key authentication only
PasswordAuthentication no
PermitEmptyPasswords no
UsePAM yes
PubkeyAuthentication yes
ChallengeResponseAuthentication no

# For safety, disable root login by default
PermitRootLogin no
StrictModes yes
AllowUsers topuser

X11Forwarding no
PrintMotd no
Subsystem sftp /usr/lib/openssh/sftp-server
EOF

    - name: Create topuser and install public key
      env:
        SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        # create user if not exists
        if ! id -u topuser >/dev/null 2>&1; then
          sudo useradd -m -s /bin/bash topuser
        fi

        # create .ssh and add public key from secret
        sudo -u topuser mkdir -p /home/topuser/.ssh
        sudo -u topuser chmod 700 /home/topuser/.ssh

        if [ -n "${SSH_PUBLIC_KEY}" ]; then
          echo "${SSH_PUBLIC_KEY}" | sudo -u topuser tee /home/topuser/.ssh/authorized_keys > /dev/null
          sudo -u topuser chmod 600 /home/topuser/.ssh/authorized_keys
        else
          echo "ERROR: SSH_PUBLIC_KEY secret is empty. Add your SSH public key to repository secrets."
          exit 1
        fi

        # optionally add topuser to sudo (comment out if you don't want sudo)
        sudo usermod -aG sudo topuser
        echo 'topuser ALL=(ALL) NOPASSWD: ALL' | sudo tee /etc/sudoers.d/topuser
        sudo chmod 440 /etc/sudoers.d/topuser

    - name: Start SSH service
      run: |
        sudo ssh-keygen -A
        sudo systemctl enable ssh
        sudo systemctl restart ssh
        echo "SSH service status:"
        sudo systemctl is-active ssh

    - name: Start Bore tunnel and show connection
      run: |
        source $HOME/.cargo/env
        echo "Starting bore local 22 -> bore.pub"
        $HOME/.cargo/bin/bore local 22 --to bore.pub > bore_output.txt 2>&1 &
        sleep 12
        cat bore_output.txt || true

        PORT=$(grep -oE "bore\.pub:[0-9]+" bore_output.txt | cut -d: -f2 || true)
        if [ -n "$PORT" ]; then
          echo "SSH connection info:"
          echo "ssh -i <PATH_TO_YOUR_PRIVATE_KEY> topuser@bore.pub -p ${PORT}"
        else
          echo "Could not extract port from bore output. See bore_output.txt above."
        fi

        # Keep job running for 6 hours so the tunnel stays up
        sleep 21600
